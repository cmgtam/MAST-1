<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MAST.parsers.inputparser &mdash; MAST 20131216.canoe documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '20131216.canoe',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="MAST 20131216.canoe documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">MAST 20131216.canoe documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for MAST.parsers.inputparser</h1><div class="highlight"><pre>
<span class="c">############################################################################</span>
<span class="c"># MAterials Simulation Toolbox (MAST)</span>
<span class="c"># Version: January 2013</span>
<span class="c"># Programmers: Tam Mayeshiba, Tom Angsten, Glen Jenness, Hyunwoo Kim,</span>
<span class="c">#              Kumaresh Visakan Murugan, Parker Sear</span>
<span class="c"># Created at the University of Wisconsin-Madison.</span>
<span class="c"># Replace this section with appropriate license text before shipping.</span>
<span class="c"># Add additional programmers and schools as necessary.</span>
<span class="c">############################################################################</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymatgen</span> <span class="kn">as</span> <span class="nn">pmg</span>

<span class="kn">from</span> <span class="nn">MAST.utility</span> <span class="kn">import</span> <span class="n">InputOptions</span>
<span class="kn">from</span> <span class="nn">MAST.utility</span> <span class="kn">import</span> <span class="n">MASTObj</span>
<span class="kn">from</span> <span class="nn">MAST.utility</span> <span class="kn">import</span> <span class="n">MASTError</span>
<span class="kn">from</span> <span class="nn">MAST.utility</span> <span class="kn">import</span> <span class="n">MAST2Structure</span>
<span class="kn">from</span> <span class="nn">MAST.utility</span> <span class="kn">import</span> <span class="n">dirutil</span>
<span class="kn">from</span> <span class="nn">MAST.utility</span> <span class="kn">import</span> <span class="n">Metadata</span>
<span class="kn">from</span> <span class="nn">MAST.utility</span> <span class="kn">import</span> <span class="n">loggerutils</span>
<span class="n">ALLOWED_KEYS</span> <span class="o">=</span> <span class="p">{</span>\
                 <span class="s">&#39;inputfile&#39;</span>    <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="s">&#39;mast.inp&#39;</span><span class="p">,</span> <span class="s">&#39;Input file name&#39;</span><span class="p">),</span>\
               <span class="p">}</span>
<span class="n">MAST_KEYWORDS</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s">&#39;system_name&#39;</span><span class="p">:</span> <span class="s">&#39;mast&#39;</span><span class="p">,</span>
                 <span class="s">&#39;mast_auto_correct&#39;</span><span class="p">:</span> <span class="s">&#39;True&#39;</span>
                <span class="p">}</span>

<span class="n">STRUCTURE_KEYWORDS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;posfile&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="s">&#39;spacegroup&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="s">&#39;symmetry_only&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                      <span class="s">&#39;coord_type&#39;</span><span class="p">:</span> <span class="s">&#39;cartesian&#39;</span><span class="p">,</span>
                      <span class="s">&#39;atom_list&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="s">&#39;coordinates&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="s">&#39;lattice&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="s">&#39;primitive&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                      <span class="s">&#39;structure&#39;</span><span class="p">:</span> <span class="bp">None</span>
                     <span class="p">}</span>

<span class="n">DEFECTS_KEYWORDS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;coord_type&#39;</span><span class="p">:</span> <span class="s">&#39;cartesian&#39;</span><span class="p">,</span>
                    <span class="s">&#39;vacancy&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
                    <span class="s">&#39;interstial&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
                    <span class="s">&#39;antisite&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
                    <span class="s">&#39;substitution&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
                   <span class="p">}</span>

<span class="n">INGREDIENTS_KEYWORDS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;singlepoint&#39;</span><span class="p">,</span>
                        <span class="s">&#39;optimization&#39;</span><span class="p">,</span>
                        <span class="s">&#39;neb&#39;</span><span class="p">,</span>
                   <span class="p">]</span>

<span class="n">RECIPE_KEYWORDS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;recipe_file&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="p">}</span>

<div class="viewcode-block" id="InputParser"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser">[docs]</a><span class="k">class</span> <span class="nc">InputParser</span><span class="p">(</span><span class="n">MASTObj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for parsing a *.inp format input file.</span>
<span class="sd">        Attributes:</span>
<span class="sd">            self.section_end &lt;str&gt;: delimiter for the end of a section</span>
<span class="sd">            self.delimiter &lt;str&gt;: character(s) for breaking up each line</span>
<span class="sd">            self.section_parsers &lt;dict&gt;: supported sections</span>
<span class="sd">            self.logger &lt;logging Logger&gt;: logger, either recipe-level or MAST input level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">MASTObj</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ALLOWED_KEYS</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_end</span> <span class="o">=</span> <span class="s">&#39;$end&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="c"># how we&#39;re breaking up each line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_parsers</span> <span class="o">=</span> <span class="p">{</span>\
                <span class="s">&#39;mast&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_mast_section</span><span class="p">,</span>
                <span class="s">&#39;structure&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_structure_section</span><span class="p">,</span>
                <span class="s">&#39;ingredients&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_ingredients_section</span><span class="p">,</span>
                <span class="s">&#39;defects&#39;</span>  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_defects_section</span><span class="p">,</span>
                <span class="s">&#39;recipe&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_recipe_section</span><span class="p">,</span>
                <span class="s">&#39;neb&#39;</span>      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_neb_section</span><span class="p">,</span>
                <span class="s">&#39;chemical_potentials&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_chemical_potentials_section</span><span class="p">,</span>
                               <span class="p">}</span>
        <span class="n">scratchpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;MAST_SCRATCH&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">inputlocation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;inputfile&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inputlocation</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;MAST_CONTROL&quot;</span><span class="p">),</span><span class="s">&quot;mast.log&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">scratchpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputlocation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;MAST_CONTROL&quot;</span><span class="p">),</span><span class="s">&quot;mast.log&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inputlocation</span><span class="p">,</span><span class="s">&quot;mast_recipe.log&quot;</span><span class="p">))</span>



<div class="viewcode-block" id="InputParser.parse"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses information from the *.inp style input file.</span>
<span class="sd">            Returns:</span>
<span class="sd">                options &lt;InputOptions&gt;: a dictionary of sections and values,</span>
<span class="sd">                                        where each section is its own</span>
<span class="sd">                                        dictionary:</span>
<span class="sd">                                        options.options[&#39;section&#39;] = dict()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span>   <span class="o">=</span> <span class="n">InputOptions</span><span class="p">()</span>
        <span class="n">infile</span>    <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="s">&#39;inputfile&#39;</span><span class="p">])</span>

        <span class="n">eof</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">eof</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c">#.lower() #Remove the lowercasing</span>
            <span class="c"># This works because the blank lines in the file are really </span>
            <span class="c"># newline (\n)!</span>
            <span class="c"># This is why strip() didn&#39;t work, cause it removed that \n, </span>
            <span class="c"># creating an empty string.</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">eof</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">)):</span>
            <span class="c"># Lines that start with a # or a ! are treated as a comment and </span>
            <span class="c"># are skipped</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section_end</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">section_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">section_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">section_parsers</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;Section </span><span class="si">%s</span><span class="s"> not recognized&#39;</span> <span class="o">%</span> <span class="n">section_name</span>
                    <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">section_content</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Found section </span><span class="si">%s</span><span class="s">.  Reading in options.&#39;</span> <span class="o">%</span> <span class="n">section_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section_end</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">section_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">section_parsers</span><span class="p">[</span><span class="n">section_name</span><span class="p">](</span><span class="n">section_name</span><span class="p">,</span> 
                        <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Finished parsing the </span><span class="si">%s</span><span class="s"> section.&#39;</span> <span class="o">%</span> <span class="n">section_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">section_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">perform_element_mapping</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_structure_from_inputs</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_execs</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">options</span>
</div>
<div class="viewcode-block" id="InputParser.parse_mast_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_mast_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_mast_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the mast section and populate the options.&quot;&quot;&quot;</span>
        <span class="n">mast_dict</span> <span class="o">=</span> <span class="n">MAST_KEYWORDS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mast_dict</span><span class="p">):</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;Section keyword </span><span class="si">%s</span><span class="s"> not recognized&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mast_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mast_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="InputParser.parse_structure_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_structure_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_structure_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the structure section and populate the options.</span>
<span class="sd">            Does not create the structure.</span>

<span class="sd">            Format is along the lines of:</span>
<span class="sd">                coord_type fractional</span>

<span class="sd">                begin coordinates</span>
<span class="sd">                Ga 0.000000 0.000000 0.000000</span>
<span class="sd">                Ga 0.500000 0.500000 0.000000</span>
<span class="sd">                Ga 0.000000 0.500000 0.500000</span>
<span class="sd">                Ga 0.500000 0.000000 0.500000</span>
<span class="sd">                As 0.250000 0.250000 0.250000</span>
<span class="sd">                As 0.750000 0.750000 0.250000</span>
<span class="sd">                As 0.250000 0.750000 0.750000</span>
<span class="sd">                As 0.750000 0.250000 0.750000</span>
<span class="sd">                end</span>

<span class="sd">                begin lattice</span>
<span class="sd">                2.0 0.0 0.0</span>
<span class="sd">                0.0 2.0 0.0</span>
<span class="sd">                0.0 0.0 2.0</span>
<span class="sd">                end</span>

<span class="sd">            Note that coord_type will default to &quot;cartesian&quot; if not specified.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Initialize with default values</span>
        <span class="n">structure_dict</span> <span class="o">=</span> <span class="n">STRUCTURE_KEYWORDS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 

        <span class="n">subsection_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">myline</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">myline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">structure_dict</span><span class="p">):</span>
                <span class="n">structure_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;begin&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">subsection</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">subsection_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;end&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">lsplit</span> <span class="o">=</span> <span class="n">myline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>
                <span class="n">lineval</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">lval</span> <span class="ow">in</span> <span class="n">lsplit</span><span class="p">:</span>
                    <span class="n">lval</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lineval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lval</span><span class="p">)</span>
                <span class="n">subsection_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineval</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">subsection_dict</span><span class="p">[</span><span class="n">subsection</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsection_list</span>

        <span class="c"># GRJ: Since we lowercase the whole input file, and filenames may not</span>
        <span class="c"># conform to this, we examine the current directory for any files that</span>
        <span class="c"># may match and use that.  If there are multiple matches, we&#39;ll throw</span>
        <span class="c"># an error.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;posfile&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span> <span class="c"># Do we have a geometry file?</span>
            <span class="c"># First build a list of likely files</span>
            <span class="n">origindir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">metatry</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">&#39;metadata.txt&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metatry</span><span class="p">):</span>
                <span class="n">myrecipemeta</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span><span class="n">metafile</span><span class="o">=</span><span class="n">metatry</span><span class="p">)</span>
                <span class="n">origindir</span> <span class="o">=</span> <span class="n">myrecipemeta</span><span class="o">.</span><span class="n">search_data</span><span class="p">(</span><span class="s">&#39;origin_dir&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">myfiles</span> <span class="o">=</span> <span class="n">dirutil</span><span class="o">.</span><span class="n">walkfiles</span><span class="p">(</span><span class="n">origindir</span><span class="p">)</span>
            <span class="n">file_list</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">myfile</span> <span class="ow">in</span> <span class="n">myfiles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;posfile&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">myfile</span><span class="p">:</span>
                    <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c"># If we have multiple files with the same name, but different capitalization, throw an error here</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Found multiple files with the name </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;posfile&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Found the files:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="n">error</span><span class="o">=</span><span class="s">&#39;Found ambiguous file names&#39;</span>
                <span class="k">raise</span> <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&quot;No structure file </span><span class="si">%s</span><span class="s"> found in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;posfile&#39;</span><span class="p">],</span> <span class="n">origindir</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;posfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># print &#39;in InputParser.parse_structure_section:&#39;, subsection_dict</span>
        <span class="c"># TM</span>
        <span class="n">element_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">atom_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">subsection_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;coordinates&#39;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="c"># Here we use .title() to re-capitalize the first letter of all </span>
                <span class="c"># the atomic symbols to comply with what</span>
                <span class="c"># pymatgen needs</span>
                <span class="n">atom_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span>
                <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;atom_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom_list</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
                <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;lattice&#39;</span><span class="p">):</span>
                <span class="c">#print &quot;VALUE: &quot;, value</span>
                <span class="n">lattice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
                <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;lattice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lattice</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;elementmap&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">elline</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">elkey</span> <span class="o">=</span> <span class="n">elline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="c">#all caps</span>
                    <span class="n">elname</span> <span class="o">=</span> <span class="n">elline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="c">#Title case</span>
                    <span class="n">element_map</span><span class="p">[</span><span class="n">elkey</span><span class="p">]</span><span class="o">=</span><span class="n">elname</span>
                <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;element_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element_map</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_atom_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">atomval</span> <span class="ow">in</span> <span class="n">atom_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atomval</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">element_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">new_atom_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element_map</span><span class="p">[</span><span class="n">atomval</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_atom_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomval</span><span class="p">)</span>
            <span class="n">structure_dict</span><span class="p">[</span><span class="s">&#39;atom_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_atom_list</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">structure_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InputParser.parse_defects_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_defects_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_defects_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the defects section and populates the options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defect_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;antisite&#39;</span><span class="p">,</span> <span class="s">&#39;vacancy&#39;</span><span class="p">,</span> <span class="s">&#39;substitution&#39;</span><span class="p">,</span> <span class="s">&#39;interstitial&#39;</span><span class="p">]</span>
        <span class="n">defect_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">multidefect</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">coord_type</span> <span class="o">=</span> <span class="s">&#39;cartesian&#39;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.e-4</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;coord_type&#39;</span><span class="p">):</span>
                <span class="n">coord_type</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;threshold&#39;</span><span class="p">):</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">defect_list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">multidefect</span><span class="p">):</span>
                <span class="n">type_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">label</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">charge</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;Defect specification requires at least 5 arguments.&#39;</span>
                    <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>

                <span class="c"># Check for static options</span>
                <span class="n">type_dict</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">type_dict</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
                <span class="n">type_dict</span><span class="p">[</span><span class="s">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]:</span>
                        <span class="n">lin</span> <span class="o">=</span> <span class="n">lin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">lin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;charge&#39;</span><span class="p">):</span>
                            <span class="n">charge_range</span> <span class="o">=</span> <span class="n">lin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                            <span class="n">charge</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">charge_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                           <span class="nb">int</span><span class="p">(</span><span class="n">charge_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">lin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;label&#39;</span><span class="p">):</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">lin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">label</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;defect_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

                <span class="n">defect</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;charge&#39;</span><span class="p">:</span> <span class="n">charge</span><span class="p">,</span>
                          <span class="s">&#39;subdefect_1&#39;</span><span class="p">:</span> <span class="n">type_dict</span><span class="p">,</span>
                          <span class="s">&#39;coord_type&#39;</span><span class="p">:</span> <span class="n">coord_type</span><span class="p">,</span>
                          <span class="s">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
                          <span class="s">&#39;phonon&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>

                <span class="c">#defect_types[&#39;defect_%s&#39; % label] = defect</span>
                <span class="n">defect_types</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">defect</span>

                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;begin&#39;</span><span class="p">):</span>
                <span class="n">defect</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">multidefect</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">subcount</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charge</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;coord_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord_type</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;phonon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;end&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">label</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;defect_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

                <span class="n">defect_types</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">defect</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">multidefect</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;charge&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">charge_range</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">charge_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                         <span class="nb">int</span><span class="p">(</span><span class="n">charge_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;phonon&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">plabel</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">p_center</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">p_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;phonon&#39;</span><span class="p">][</span><span class="n">plabel</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;phonon&#39;</span><span class="p">][</span><span class="n">plabel</span><span class="p">][</span><span class="s">&#39;phonon_center_site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_center</span>
                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;phonon&#39;</span><span class="p">][</span><span class="n">plabel</span><span class="p">][</span><span class="s">&#39;phonon_center_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_radius</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">type_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;Defect specification requires at least 5 arguments.&#39;</span>
                    <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>

                <span class="c"># Check for static options</span>
                <span class="n">type_dict</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">type_dict</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
                <span class="n">type_dict</span><span class="p">[</span><span class="s">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                <span class="n">defect</span><span class="p">[</span><span class="s">&#39;subdefect_</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">subcount</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_dict</span>
                <span class="c"># print &#39;Rawr!&#39;, defect</span>
                <span class="n">subcount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s">&#39;num_defects&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s">&#39;defects&#39;</span><span class="p">,</span> <span class="n">defect_types</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s">&#39;coord_type&#39;</span><span class="p">,</span> <span class="n">coord_type</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InputParser.parse_recipe_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_recipe_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_recipe_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the recipe section and populates the options.&quot;&quot;&quot;</span>
        <span class="n">recipe_dict</span> <span class="o">=</span> <span class="n">RECIPE_KEYWORDS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recipe_dict</span><span class="p">):</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;Section keyword </span><span class="si">%s</span><span class="s"> not recognized&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;recipe_file&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">recipe_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;MAST_RECIPE_PATH&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;MAST_RECIPE_PATH environment variable not set&#39;</span>
                    <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> 
                <span class="n">recipe_dict</span><span class="p">[</span><span class="s">&#39;recipe_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">recipe_path</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">recipe_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">recipe_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InputParser.parse_ingredients_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_ingredients_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_ingredients_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the ingredients section and populates the options.</span>
<span class="sd">            Section takes the form of:</span>
<span class="sd">                $ingredients</span>
<span class="sd">                begin ingredients_global</span>
<span class="sd">                mast_kpoints 3x3x3</span>
<span class="sd">                mast_xc pbe</span>
<span class="sd">                end</span>

<span class="sd">                begin singlepoint</span>
<span class="sd">                encut 400</span>
<span class="sd">                end</span>

<span class="sd">                begin optimize</span>
<span class="sd">                encut 300</span>
<span class="sd">                ibrion 2</span>
<span class="sd">                end</span>

<span class="sd">                $end</span>

<span class="sd">            mast_kpoints are parsed out as a 3 index list of integers. </span>
<span class="sd">            Everything else is parsed out as a string.</span>

<span class="sd">            Anything in ingredients_global is then appended onto each </span>
<span class="sd">            individual ingredient.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">global_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">ingredients_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;begin&#39;</span><span class="p">)):</span>
                <span class="c"># Each ingredient section starts with &quot;begin&quot;.</span>
                <span class="c"># Check for this line, and initialize the individual</span>
                <span class="c"># ingredient dictionary</span>
                <span class="n">ingredient_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ingredient_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;end&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="c"># print opt</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;mast_kpoints&#39;</span><span class="p">):</span>
                    <span class="n">kpts</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span>
                    <span class="c"># Second option after mast_kpoints tells where to </span>
                    <span class="c"># center the k-point mesh.</span>
                    <span class="c"># If it&#39;s there, we append it onto the k-point grid list.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">kpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">ingredient_dict</span><span class="p">[</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kpts</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;mast_pp_setup&#39;</span><span class="p">):</span>
                    <span class="n">psp_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
                        <span class="n">ref</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">psp_dict</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">ingredient_dict</span><span class="p">[</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">psp_dict</span>
                <span class="c">#elif (opt[0] == &#39;mast_exec&#39;):</span>
                <span class="c">#    ingredient_dict[opt[0]] = &#39; &#39;.join(opt[1:]) #preserve whole line</span>
                <span class="c">#elif (opt[0] == &#39;mast_strain&#39;):</span>
                <span class="c">#    ingredient_dict[opt[0]] = &#39; &#39;.join(opt[1:]) #preserve whole line</span>
                <span class="c">#elif (opt[0] == &#39;ptemp&#39;):</span>
                <span class="c">#    ingredient_dict[opt[0]] = &#39; &#39;.join(opt[1:]) #preserve whole line </span>
                <span class="c">#elif (opt[0] == &#39;rwigs&#39;):</span>
                <span class="c">#    ingredient_dict[opt[0]] = &#39; &#39;.join(opt[1:]) #preserve whole line</span>
                <span class="c">#elif (opt[0] == &#39;mast_setmagmom&#39;):</span>
                <span class="c">#    ingredient_dict[opt[0]] = &#39; &#39;.join(opt[1:]) #preserve whole line</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;mast_coordinates&#39;</span><span class="p">):</span>
                    <span class="n">shortsplit</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">filesplit</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
                    <span class="n">origindir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                    <span class="n">metatry</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">&#39;metadata.txt&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metatry</span><span class="p">):</span>
                        <span class="n">myrecipemeta</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">(</span><span class="n">metafile</span><span class="o">=</span><span class="n">metatry</span><span class="p">)</span>
                        <span class="n">origindir</span> <span class="o">=</span> <span class="n">myrecipemeta</span><span class="o">.</span><span class="n">search_data</span><span class="p">(</span><span class="s">&#39;origin_dir&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">myfiles</span> <span class="o">=</span> <span class="n">dirutil</span><span class="o">.</span><span class="n">walkfiles</span><span class="p">(</span><span class="n">origindir</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">shortname</span> <span class="ow">in</span> <span class="n">shortsplit</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">fullfile</span> <span class="ow">in</span> <span class="n">myfiles</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">shortname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fullfile</span><span class="p">):</span>
                                <span class="n">filesplit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fullfile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filesplit</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shortsplit</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&quot;Not all files given by </span><span class="si">%s</span><span class="s"> were found in </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shortsplit</span><span class="p">,</span> <span class="n">origindir</span><span class="p">))</span>
                    <span class="n">ingredient_dict</span><span class="p">[</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">filesplit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ingredient_dict</span><span class="p">[</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="c">#preserve whole line</span>
                    <span class="c">#ingredient_dict[opt[0]] = opt[1] #old behavior took only the first part</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;mast_program&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;vasp&#39;</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;vasp_neb&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;VASP_PSP_DIR&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&quot;Input file specifies program vasp, but no POTCAR directory is set in environment variable VASP_PSP_DIR&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="c"># Each ingredient section ends with &quot;end&quot;, if present finish </span>
                <span class="c"># that current section and assign</span>
                <span class="c"># the neccessary element in the ingredients dictionary and </span>
                <span class="c"># create the global dictionary</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ingredient_name</span> <span class="o">==</span> <span class="s">&#39;ingredients_global&#39;</span><span class="p">):</span>
                    <span class="n">global_dict</span> <span class="o">=</span> <span class="n">ingredient_dict</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ingredients_dict</span><span class="p">[</span><span class="n">ingredient_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingredient_dict</span>

        <span class="c"># Each value in ingredients_dict is a dictionary containing the relevant</span>
        <span class="c"># ingredient and option(s).</span>
        <span class="k">for</span> <span class="n">ing_key</span><span class="p">,</span> <span class="n">ing_value</span> <span class="ow">in</span> <span class="n">ingredients_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">ing_key</span><span class="p">,</span> <span class="n">ing_value</span><span class="p">)</span>

        <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s">&#39;global&#39;</span><span class="p">,</span> <span class="n">global_dict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InputParser.parse_neb_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_neb_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_neb_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the neb section and populates the options.</span>
<span class="sd">            </span>
<span class="sd">            The number of images is specified and must be the same</span>
<span class="sd">            throughout the recipe.</span>

<span class="sd">            Each neb gets a label which should correspond to a defect group</span>
<span class="sd">            or defect group number.</span>

<span class="sd">            Within each subsection, each line specifies which atom is moving,</span>
<span class="sd">            giving its element name and its approximate coordinates from</span>
<span class="sd">            the starting unrelaxed structure.</span>

<span class="sd">            $neb</span>

<span class="sd">            images 3</span>

<span class="sd">            begin crowdion1-crowdion2</span>
<span class="sd">            Cr, 0 0.3 0, 0 0 0</span>
<span class="sd">            Ni, 0 0.6 0, 0 0.3 0</span>
<span class="sd">            end</span>

<span class="sd">            begin int1-int2</span>
<span class="sd">            Mg, 0 0 0.5, 0.3 0.1 2</span>
<span class="sd">            end</span>

<span class="sd">            $end</span>

<span class="sd">            In the crowdion example, the starting undefected structure is</span>
<span class="sd">            defected three times in each defect group: 1 vacancy and two</span>
<span class="sd">            antisites. The neb section allows us to unambiguously match up </span>
<span class="sd">            the atoms and determine which atoms are moving, and where. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nebs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">images</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">neblabel</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c">#if &#39;images&#39; in line:</span>
            <span class="c">#    line = line.split(self.delimiter)</span>
            <span class="c">#    images = int(line[1])</span>
            <span class="k">if</span> <span class="s">&#39;begin&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>
                <span class="n">neblabel</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
                <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">][</span><span class="s">&#39;lines&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
                <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">][</span><span class="s">&#39;phonon&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">neblabel</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="c">#use commas for element lines</span>
                <span class="k">if</span> <span class="s">&#39;phonon&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">plabel</span> <span class="o">=</span> <span class="n">sline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">p_center</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sline</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">p_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sline</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">][</span><span class="s">&#39;phonon&#39;</span><span class="p">][</span><span class="n">plabel</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
                    <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">][</span><span class="s">&#39;phonon&#39;</span><span class="p">][</span><span class="n">plabel</span><span class="p">][</span><span class="s">&#39;phonon_center_site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_center</span>
                    <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">][</span><span class="s">&#39;phonon&#39;</span><span class="p">][</span><span class="n">plabel</span><span class="p">][</span><span class="s">&#39;phonon_center_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_radius</span>
                <span class="k">elif</span> <span class="s">&#39;images&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">][</span><span class="s">&#39;images&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nebs</span><span class="p">[</span><span class="n">neblabel</span><span class="p">][</span><span class="s">&#39;lines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c">#options.set_item(section_name, &#39;images&#39;, images)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s">&#39;nebs&#39;</span><span class="p">,</span> <span class="n">nebs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="InputParser.parse_chemical_potentials_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_chemical_potentials_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_chemical_potentials_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the chemical_potentials section and populates the options.</span>
<span class="sd">            Section uses the standard begin...end subsection structure, but with</span>
<span class="sd">            a modification: instead of strict subsection titles (i.e. structure,</span>
<span class="sd">            lattice etc.), subsection titles are the conditions under which the</span>
<span class="sd">            chemical potentials are for.  Any combination of white spacing is</span>
<span class="sd">            allowed, however note that all conditions will be converted to lower</span>
<span class="sd">            case first!</span>

<span class="sd">            Using a GaAs example, hypothetically we could have a </span>
<span class="sd">            chemical_potential section like the following:</span>
<span class="sd">                $chemical_potentials</span>
<span class="sd">                begin As rich</span>
<span class="sd">                Ga 4.5</span>
<span class="sd">                As 3.5</span>
<span class="sd">                end</span>

<span class="sd">                begin Ga rich</span>
<span class="sd">                Ga 3.5</span>
<span class="sd">                As 4.5</span>
<span class="sd">                end</span>
<span class="sd">                $end</span>

<span class="sd">            For charged defects, note that the chemical potential of the</span>
<span class="sd">            electron will be calculated automatically from the Fermi level and</span>
<span class="sd">            appropiate potential shift correction.  However, if one desires to</span>
<span class="sd">            manually give an electron chemical potential (for whatever reason!)</span>
<span class="sd">            this can be done by specifiying \&#39;electron\&#39; in the appropiate</span>
<span class="sd">            condition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chempot_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;begin&#39;</span><span class="p">)):</span>
                <span class="n">condition_name</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">condition_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;end&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">condition_dict</span><span class="p">[</span><span class="n">opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">chempot_dict</span><span class="p">[</span><span class="n">condition_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_dict</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">chempot_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="InputParser.parse_phonon_section"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.parse_phonon_section">[docs]</a>    <span class="k">def</span> <span class="nf">parse_phonon_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section_content</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the phonon section and populates the options.</span>
<span class="sd">            </span>
<span class="sd">            The phonon_center_site is a coordinate (as a string, like &quot;0 0 0&quot;)</span>
<span class="sd">                for the center of the phonon calculations. Give a coordinate</span>
<span class="sd">                of an atom for that atom.</span>
<span class="sd">                Do not set this value in order to calculate phonons for all</span>
<span class="sd">                atoms.</span>
<span class="sd">            The phonon_center_radius is a radius in ANGSTROMS to search for</span>
<span class="sd">                neighbors to the phonon_center_site, and also take into account</span>
<span class="sd">                their vibrations.</span>
<span class="sd">                Do not set this value or set to 0 to only calculate phonons</span>
<span class="sd">                for the atom given in phonon_center_site.</span>
<span class="sd">            All phonons must be enclosed in a begin and end tag within the </span>
<span class="sd">            phonon section. Phonons should be labeled</span>
<span class="sd">            xxxx_phonon_label and the label should correspond to the </span>
<span class="sd">            auto-generation of the</span>
<span class="sd">            recipe (e.g. corresponding exactly to defect group names like vac1</span>
<span class="sd">            or to neb image names like vac1-vac2_02)</span>

<span class="sd">            $phonon</span>

<span class="sd">            begin crowdion1</span>
<span class="sd">            phonon_center_site 0 0.3 0</span>
<span class="sd">            phonon_center_radius 2</span>
<span class="sd">            end</span>
<span class="sd">            </span>
<span class="sd">            begin crowdion1-crowdion2_02</span>
<span class="sd">            phonon_center_site 0 0.15 0</span>
<span class="sd">            phonon_center_radius 2</span>
<span class="sd">            end</span>

<span class="sd">            $end</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="s">&quot;Phonon section in input files *.inp is obsolete. Phonons now go in the defects and neb sections.&quot;</span><span class="p">)</span>
        <span class="n">phonon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;begin&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">phonon</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">phonon</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">options</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s">&#39;phonon&#39;</span><span class="p">,</span> <span class="n">phonon</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="InputParser.perform_element_mapping"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.perform_element_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">perform_element_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform element mapping if there is an element map specified,</span>
<span class="sd">            so that defects and NEB lines get the correct element name.</span>
<span class="sd">            Args:</span>
<span class="sd">                input_options &lt;InputOptions&gt;</span>
<span class="sd">            Returns:</span>
<span class="sd">                modifies input_options dictionary entries in place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#print self.input_options.get_section_keys(&#39;structure&#39;)</span>
        <span class="n">eldict</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;element_map&#39;</span> <span class="ow">in</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_section_keys</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">):</span>
            <span class="n">eldict</span> <span class="o">=</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="s">&#39;element_map&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eldict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s">&#39;defects&#39;</span> <span class="ow">in</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_sections</span><span class="p">():</span>
            <span class="n">defdict</span> <span class="o">=</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;defects&#39;</span><span class="p">,</span><span class="s">&#39;defects&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dkey</span> <span class="ow">in</span> <span class="n">defdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">sdkey</span> <span class="ow">in</span> <span class="n">defdict</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s">&#39;subdefect&#39;</span> <span class="ow">in</span> <span class="n">sdkey</span><span class="p">:</span>
                        <span class="n">symbol</span> <span class="o">=</span> <span class="n">defdict</span><span class="p">[</span><span class="n">dkey</span><span class="p">][</span><span class="n">sdkey</span><span class="p">][</span><span class="s">&#39;symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">eldict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">defdict</span><span class="p">[</span><span class="n">dkey</span><span class="p">][</span><span class="n">sdkey</span><span class="p">][</span><span class="s">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eldict</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;neb&#39;</span> <span class="ow">in</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_sections</span><span class="p">():</span>
            <span class="n">nebdict</span> <span class="o">=</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;neb&#39;</span><span class="p">,</span><span class="s">&#39;nebs&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">nebkey</span> <span class="ow">in</span> <span class="n">nebdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">nlinenum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nebdict</span><span class="p">[</span><span class="n">nebkey</span><span class="p">][</span><span class="s">&#39;lines&#39;</span><span class="p">])</span>
                <span class="n">nlinect</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">while</span> <span class="n">nlinect</span> <span class="o">&lt;</span> <span class="n">nlinenum</span><span class="p">:</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">nebdict</span><span class="p">[</span><span class="n">nebkey</span><span class="p">][</span><span class="s">&#39;lines&#39;</span><span class="p">][</span><span class="n">nlinect</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">eldict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">nebdict</span><span class="p">[</span><span class="n">nebkey</span><span class="p">][</span><span class="s">&#39;lines&#39;</span><span class="p">][</span><span class="n">nlinect</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eldict</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                    <span class="n">nlinect</span> <span class="o">=</span> <span class="n">nlinect</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span>


</div>
<div class="viewcode-block" id="InputParser.validate_execs"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.validate_execs">[docs]</a>    <span class="k">def</span> <span class="nf">validate_execs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure each ingredient has a mast_exec line.</span>
<span class="sd">            Args:</span>
<span class="sd">                input_options &lt;InputOptions&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">have_exec</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">ingredient</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;ingredients&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;mast_exec&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">have_exec</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">have_exec</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">have_exec</span><span class="p">):</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;mast_exec keyword not found in the $ingredients section&#39;</span>
            <span class="k">raise</span> <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span></div>
<div class="viewcode-block" id="InputParser.set_structure_from_inputs"><a class="viewcode-back" href="../../../MAST.parsers.inputparser.html#MAST.parsers.inputparser.InputParser.set_structure_from_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">set_structure_from_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a pymatgen structure and update the</span>
<span class="sd">            structure key.</span>
<span class="sd">            Args:</span>
<span class="sd">                input_options &lt;InputOptions&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strposfile</span> <span class="o">=</span> <span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="s">&#39;posfile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strposfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">iopscoords</span><span class="o">=</span><span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="s">&#39;coordinates&#39;</span><span class="p">)</span>
            <span class="n">iopslatt</span><span class="o">=</span><span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="s">&#39;lattice&#39;</span><span class="p">)</span>
            <span class="n">iopsatoms</span><span class="o">=</span><span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="s">&#39;atom_list&#39;</span><span class="p">)</span>
            <span class="n">iopsctype</span><span class="o">=</span><span class="n">input_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="s">&#39;coord_type&#39;</span><span class="p">)</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">MAST2Structure</span><span class="p">(</span><span class="n">lattice</span><span class="o">=</span><span class="n">iopslatt</span><span class="p">,</span>
                <span class="n">coordinates</span><span class="o">=</span><span class="n">iopscoords</span><span class="p">,</span> <span class="n">atom_list</span><span class="o">=</span><span class="n">iopsatoms</span><span class="p">,</span>
                <span class="n">coord_type</span><span class="o">=</span><span class="n">iopsctype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;poscar&#39;</span> <span class="ow">in</span> <span class="n">strposfile</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="kn">from</span> <span class="nn">pymatgen.io.vaspio</span> <span class="kn">import</span> <span class="n">Poscar</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">Poscar</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">strposfile</span><span class="p">)</span><span class="o">.</span><span class="n">structure</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;cif&#39;</span> <span class="ow">in</span> <span class="n">strposfile</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="kn">from</span> <span class="nn">pymatgen.io.cifio</span> <span class="kn">import</span> <span class="n">CifParser</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">CifParser</span><span class="p">(</span><span class="n">strposfile</span><span class="p">)</span><span class="o">.</span><span class="n">get_structures</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;Cannot build structure from file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">strposfile</span>
            <span class="k">raise</span> <span class="n">MASTError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">input_options</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="s">&#39;structure&#39;</span><span class="p">,</span><span class="n">structure</span><span class="p">)</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/MAST_logo_200px.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">MAST 20131216.canoe documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, CMG.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>